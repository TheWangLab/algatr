---
title: "TESS"
output: html_document
editor_options: 
  chunk_output_type: inline
---

# Setup

```{r, warning = FALSE, message = FALSE}
library("here")
library("tidyverse")
library("raster")
library("rgdal")
# Figure out libraries later
# to install TESS:
# install.packages("devtools")
# devtools::install_github("bcm-uga/TESS3_encho_sen")
library("tess3r") 


#for plotting (from TESS)
source("http://membres-timc.imag.fr/Olivier.Francois/Conversion.R")
source("http://membres-timc.imag.fr/Olivier.Francois/POPSutilities.R")

# need LEA library for cross entropy
#if (!requireNamespace("BiocManager", quietly = TRUE))
#install.packages("BiocManager")
#BiocManager::install("LEA")
#library("LEA")

# devtools::install_github("cran/automap")
library("automap")
library("spatialEco")

devtools::load_all()
```
### Load Test Data

```{r, warning = FALSE}
# gen matrix
load(here("data", "gendist.RDA"))
load(here("data", "liz_coords.RDA"))
load(here("data", "CA_env.RDA"))
load(here("data", "liz_vcf.RDA"))
gen <- vcf_to_dosage(liz_vcf)
grid <- aggregate(CA_env[[1]], 4)
```


# Do everything function
```{r, cache = TRUE, results = FALSE, warning = FALSE, fig.width = 5, fig.height = 5}
par(pty = "s", mar = rep(2,4))
results <- tess_full(gen, liz_coords, grid, Kvals = 1:3, K_selection = "auto", minQ = 0.10)
```


# Plotting 

## Example TESS

### Run TESS

```{r, cache = TRUE}
# run K test
tess3_result <- tess_ktest(gen, liz_coords, Kvals = 1:10, ploidy = 2) 

# look at resulting object (ANNE: provide a description of what is in this object)
summary(tess3_result)

# get tess object
tess3_obj <- tess3_result$tess3_obj

# get best K and get Qmatrix
qmat <- qmatrix(tess3_obj, K = tess3_result$K)

```

### Krig Q values

```{r, cache = TRUE, results = FALSE, warning = FALSE}
# krige Qmatrix
krig_admix <- tess_krig(qmat, liz_coords, grid)
```

## Plotting 

### Basic ggplot

```{r, fig.width = 5, fig.height = 5}
tess_ggplot(krig_admix, liz_coords, plot_method = "maxQ")
tess_ggplot(krig_admix, liz_coords, plot_method = "maxQ_poly")
tess_ggplot(krig_admix, liz_coords, plot_method = "allQ", minQ = 0.20)
tess_ggplot(krig_admix, liz_coords, plot_method = "allQ_poly", minQ = 0.20)
```

```{r}
tess_barplot(qmat, border = NA, space = 0, xlab = "Individuals", ylab = "Ancestry coefficients")
```

## Extended base R plotting

To plot individual layers and have more control over color breaks, alpha levels, legend/color scale settings, etc. use base R plotting functions

```{r, fig.width = 10, fig.height = 4}
par(mfrow = c(1, nlayers(krig_admix)), mar = rep(2,4), oma = rep(1,4))
tess_plot_allK(krig_admix, col_breaks = 20, legend.width = 2)
```

```{r, fig.width = 5, fig.height = 5, warning = FALSE}
par(mfrow = c(2,2), pty = "s", mar = rep(0,4))

tess_plot(krig_admix, plot_method = "maxQ", col_breaks = 20)
tess_plot(krig_admix, plot_method = "allQ", col_breaks = 20, minQ = 0.20, col_alpha = 0.90)
tess_plot(krig_admix, plot_method = "maxQ_poly")
tess_plot(krig_admix, plot_method = "allQ_poly", minQ = 0.20, col_alpha = 0.50)
```

## Plotting with default package funciton

```{r}
barplot(qmat, sort.by.Q = TRUE,
            border = NA, space = 0,
            xlab = "Individuals", ylab = "Ancestry coefficients")
```

```{r, fig.width = 5, fig.height = 5}
plot(qmat, 
     liz_coords, 
     method = "map.max", 
     interpol = FieldsKrigModel(10),  
     main = "Ancestry coefficients",
     xlab = "Longitude", ylab = "Latitude", 
     col.palette = CreatePalette(),
     resolution = c(300,300), cex = .4)

par(pty = "s", mar = rep(0,4))
tess_plot(krig_admix, liz_coords, plot_method = "maxQ", col_pal =  tess_col_default)
```
