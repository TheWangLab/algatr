---
title: "RDA"
output: html_document
---

# Setup

```{r, warning=FALSE, message=FALSE}
library("here")
library("gt")
# RDA
library("vegan")
library("raster")
library("robust")
library("tidyverse")
# BiocManager::install("qvalue")
library("qvalue")
devtools::load_all()
```

### Load Test Data

```{r, warning = FALSE}
load_example()
gen <- vcf_to_dosage(liz_vcf)
coords <- liz_coords
env <- CA_env

# Perform simple imputation using the median
# NOTE: We do this for our test data set, but highly discourage using this form of simplistic imputation in analyses. 
gen <- impute_na(gen, median)
```

# Run RDA
```{r, warning = FALSE, message = FALSE}
results <- rda_do_everything(gen, env, coords, 
                            correctGEO = FALSE, 
                            correctPC = FALSE,
                            outlier_method = "p",
                            sig = 0.05, 
                            padj_method = "fdr")
```

```{r}
results <- rda_do_everything(gen, env, coords, 
                            correctGEO = FALSE, 
                            correctPC = FALSE,
                            outlier_method = "z",
                            z = 3, 
                            padj_method = "fdr")
```



# Partial RDAs

## Geo correction
```{r, warning = TRUE, message = FALSE}
results <- rda_do_everything(gen, 
                            env, 
                            coords, 
                            model = "full",
                            correctGEO = TRUE, 
                            correctPC = FALSE,
                            sig = 0.05, 
                            padj_method = "fdr")
```

## PC correction
```{r, warning = TRUE, message = FALSE}
results <- rda_do_everything(gen, 
                            env, 
                            coords, 
                            model = "full",
                            correctGEO = FALSE, 
                            correctPC = TRUE,
                            sig = 0.05, 
                            padj_method = "fdr")
```

## PC + Geo Correction
```{r, warning = TRUE, message = FALSE}
results <- rda_do_everything(gen, 
                            env, 
                            coords, 
                            model = "full",
                            correctGEO = TRUE, 
                            correctPC = TRUE,
                            sig = 0.05, 
                            padj_method = "fdr")
```

## Variable selection

```{r, warning = TRUE, message = FALSE}
results <- rda_do_everything(gen, 
                            env, 
                            coords, 
                            model = "best",
                            correctGEO = FALSE, 
                            correctPC = FALSE,
                            sig = 0.05, 
                            padj_method = "fdr")
```

## Separate functions

### 1. Prepare data
```{r}
# Extract and standardize environmental variables
env <- raster::extract(CA_env, coords)
env <- scale(env, center = TRUE, scale = TRUE) 
env <- data.frame(env)
    
# Remove any NA values
if(any(is.na(env))){
  warning("NA values found in env data, removing rows with NAs for RDA")
  gen <- gen[complete.cases(env),]
  coords <- coords[complete.cases(env),]
  env <- env[complete.cases(env),]
}
if(any(is.na(gen))){
  warning("NA values found in gen data, removing rows with NAs for RDA")
  env <- env[complete.cases(gen),]
  coords <- coords[complete.cases(gen),]
  gen <- gen[complete.cases(gen),]
}
```

### 2. Run RDA
```{r}
mod <- rda_run(gen, env, coords, correctGEO = FALSE, correctPC = FALSE)
```


### 3. Identify candidate snps
```{r}

# Running with all axes and z method
rda_sig <- rda_getsnps(mod, naxes = "all", outlier_method = "z", z = 3)
rda_snps <- rda_sig[["rda_snps"]]
length(rda_snps)

# Running with all axes and p method
rda_sig <- rda_getsnps(mod, naxes = "all", outlier_method = "p", padj_method = "fdr", sig = 0.05)
rda_snps <- rda_sig[["rda_snps"]]
pvalues <- rda_sig[["pvalues"]]
length(rda_snps)

```

### 4. Identify environmental associations
```{r}
rda_gen <- gen[,rda_snps]
lm_df <- rda_lm_test(rda_gen, env)
```

### 5. Plot results

```{r}
rda_plot(mod, rda_snps, biplot_axes = c(1,3), rdaplot = TRUE)
rda_plot(mod, rda_snps, biplot_axes = c(2,3), rdaplot = TRUE)
rda_plot(mod, rda_snps, pvalues, sig = 0.05, manhattan = TRUE, rdaplot = FALSE)

# note: if only one axis is provided, a histogram will be generated
rda_plot(mod, rda_snps, axes = 1, rdaplot = TRUE, binwidth = 0.01)
```



