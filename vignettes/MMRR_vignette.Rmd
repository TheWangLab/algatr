---
title: "MMRR_vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MMRR_vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Multiple matrix regression with randomization (MMRR)

```{r setup, warning = FALSE, message = FALSE}
library(algatr)
library(here)
library(raster)
devtools::load_all()
```

**If using MMRR, please cite the following: Wang I.J. (2013) Examining the full effects of landscape heterogeneity on spatial genetic variation: a multiple matrix regression approach for quantifying geographic and ecological isolation. Evolution 67(1):3403-3411. DOI:10.1111/evo.12134**

Multiple matrix regression with randomization ([Wang 2013](https://onlinelibrary.wiley.com/doi/full/10.1111/evo.12134)) examines how heterogeneity in the landscape (both geographic and environmental) affects spatial genetic variation, allowing a user to determine the relative contributions of isolation by distance (i.e., an association between genetic and geographic distances) and isolation by environment (i.e., an association between genetic and environmental distances). MMRR can provide information concerning how dependent variables (in our case, genetic data) change with respect to multiple independent variables (environmental and geographic distances).

The randomization aspect of MMRR is that significance testing is performed through random permutations of the rows and columns of the dependent matrix (the genetic distances), which is necessary because of the non-independence of values in pairwise distance matrices. Once significance testing is completed, MMRR provides individual regression coefficients and p-values for each dependent variable and a "coefficient ratio," which is the ratio between regression coefficients, which thus provides an idea of the relative contributions of IBD and IBE in explaining variation in the genetic distances in your data.

There are a few assumptions built into this function that users should be aware of: (1) the coordinates and genetic distance files MUST have the same ordering of individuals; there isn't a check for this, and (2) this function assumes that each individual has its own sampling coordinates (even if population-based sampling was performed).

### Read in and process genetic data

Let's load the example dataset and extract environmental variables based on our sampling coordinates. To perform MMRR, we need a genetic distance matrix; please refer to the genetic distances vignette for information on how to generate this in algatr using a vcf file.

```{r genetic data, warning = FALSE}
load_algatr_example()
Y <- as.matrix(liz_gendist)
```

### Process environmental data

Let's calculate environmental distances with our extracted environmental values using the `env_dist()` function, and add on geographic distances to this matrix using the `geo_dist()` function. For more information on how these two functions work, please refer to algatr's environmental data processing vignette.

```{r enviro data}
# Extract enviro vars
env <- raster::extract(CA_env, liz_coords)
# Calculate environmental distances
X <- env_dist(env)
# Add geographic distance to X
X[["geodist"]] <- geo_dist(liz_coords)
```

## Run MMRR

------------------------------------------------------------------------

We can run MMRR either by running the full model (with no variable selection) using the `mmrr_full()` function, or by running a variable selection procedure using backwards elimination using the `mmrr_best()` function. Regardless of the function, the arguments are the same:

-   `Y`: matrix of genetic distances

-   `X`: matrix of environmental distances (including geographic distances) at each sampling coordinate

-   `nperm`: number of permutations to perform

-   `stdz`: whether matrices are standardized

-   `quiet`: whether to plot results

### MMRR with all variables

First, let's run the full MMRR model with all variables included (i.e., no variable selection).

```{r mmrr full}
set.seed(10)
results_full <- mmrr_full(Y, X, nperm = 99, stdz = TRUE, quiet = TRUE)
```

The results from MMRR "full" contains four elements:

-   `coeff_df`: a dataframe with statistics relating to each variable's distance related to genetic distance, including coefficient values for each environmental variable and geographic distance

-   `mod`: a dataframe containing statistics for the results of the model, including an R\^2 value, and F statistics

-   `X` and `Y`: the input data

### MMRR with model selection

Now, let's run MMRR with variable selection.

```{r mmrr best}
# Run MMRR with all variables
set.seed(01)
results_best <- mmrr_best(Y, X, nperm = 99, stdz = TRUE, quiet = TRUE)
```

Once again, the results from `mmrr_best()` contains the same elements as `mmrr_full()`, except that `mmrr_best()` now also has `X_best`, which contains values for significant variables; in this case, the only significant variable found was geographic distance. You can also see that the `coeff_df` element is reduced from all four variables to only those variables that were significantly associated with genetic distance (in the test example case, only geographic distance).

## Visualizing MMRR results

------------------------------------------------------------------------

### Plotting MMRR results with `mmrr_plot()`

Let's take a look at the results from our MMRR analyses above. We can produce several plots to visualize results with the `mmrr_plot()` function, including plotting single variable relationships (`plot_type = "vars"`), plotting the fitted relationship that compares predicted against the observed genetic distances (`plot_type = "fitted"`), or plotting covariances between the predictor variables (`plot_type = "cov"`). Lastly, you can set `plot_type = "all"` to produce all three of these plots for your MMRR run.

```{r mmrr plots, fig.width = 5, fig.height = 5, fig.align='center'}
# Single variable plot
mmrr_plot(Y, X, mod = results_full$mod, plot_type = "vars", stdz = TRUE)
```

```{r fitted plot, fig.width = 5, fig.height = 5, fig.align='center'}
# Fitted variable plot
mmrr_plot(Y, X, mod = results_full$mod, plot_type = "fitted", stdz = TRUE)
```

```{r cov plot, fig.width = 5, fig.height = 5, fig.align='center'}
# Covariance plot
mmrr_plot(Y, X, mod = results_full$mod, plot_type = "cov", stdz = TRUE)
```

How do the above results compare to those from the "best" model?

```{r mmrr best plots, fig.width = 5, fig.height = 5, fig.align='center'}
mmrr_plot(Y, X, mod = results_best$mod, plot_type = "all", stdz = TRUE)
```

### Look at MMRR output statistics with `mmrr_table()`

We can also take a closer look at the output statistics from our MMRR runs using the `mmrr_table()` function. This function will also provide summary statistics if we set `summary_stats` to TRUE (the default). The estimate column contains the coefficients for each of the variables. *N.B.: significance values may change slightly due to the permutation procedure.*

```{r stats}
mmrr_table(results_full, digits = 2, summary_stats = TRUE)
```

## Running MMRR with `mmrr_do_everything()`

------------------------------------------------------------------------

The algatr package also has an option to run all of the above functionality in a single function, `mmrr_do_everything()`. This function runs MMRR while specifying whether a user would like to run variable selection or not (using the `model` argument), producing a table and all plots automatically. It will automatically extract environmental variables based on coordinates and calculate environmental distances from these data.

### MMRR with all variables

```{r all vars, fig.width = 5, fig.height = 5, fig.align='center', warning=FALSE}
# TODO [EAC]: error with do everything round() non-numeric arg, also check env
set.seed(01)
mmrr_do_everything(liz_gendist, liz_coords, env = CA_env, model = "full")
```

### MMRR with model selection

```{r best vars, fig.width = 5, fig.height = 5, fig.align='center', warning=FALSE}
set.seed(10)
mmrr_do_everything(liz_gendist, liz_coords, env = CA_env, model = "best", nperm = 100)
```

## Additional documentation and citations

------------------------------------------------------------------------

|                        | Citation/URL                                                                                     | Details                      |
|-----------------|------------------------------|-------------------------|
| Manuscript with method |  [Wang 2013](https://onlinelibrary.wiley.com/doi/full/10.1111/evo.12134)                         | Paper describing MMRR method |
| Associated code        | [MMRR tutorial](https://nature.berkeley.edu/wanglab/wp-content/uploads/2019/09/MMRRtutorial.zip) | Walkthrough of MMRR          |
