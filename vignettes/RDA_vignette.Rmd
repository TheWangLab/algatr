---
title: "RDA_vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{RDA_vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, warning=FALSE, message=FALSE}
library(algatr)
library("here")
library("gt")
# RDA
library("vegan")
library("raster")
library("robust")
library("tidyverse")
# BiocManager::install("qvalue")
library("qvalue")
devtools::load_all()
```

### Load Test Data

```{r, warning = FALSE}
# convert vcf to dosage
vcf_to_dosage(vcf_path)

# take a look at the dosage matrix


# gen matrix
gen <- read.csv(here("test_data","gen_dosage_mat.csv"))
gen <- gen[,-1]
# coords
coords <- read.table(here("test_data","Scelop.coord"))
# And a set of worldclim rasters for the study area
env_files <- list.files(here("data","PC_layers"), full.names = TRUE)
envstack <- raster::stack(env_files)
#make env
env <- raster::extract(envstack, coords)
```

# Run RDA
```{r, warning = FALSE, message = FALSE}
results <- rda_doEverything(gen, env, coords, 
                            correctGEO = FALSE, 
                            correctPC = FALSE,
                            alpha = 0.05, 
                            padj_method = "fdr")
```

```{r warning = FALSE}
lm_table(results$lm_df)
```

# Partial RDAs

## Geo correction
```{r, warning = TRUE, message = FALSE}
results <- rda_doEverything(gen, 
                            env, 
                            coords, 
                            correctGEO = FALSE, 
                            correctPC = TRUE,
                            alpha = 0.05, 
                            padj_method = "fdr")
lm_table(results$lm_df)
```

## PC correction
```{r, warning = TRUE, message = FALSE}
results <- rda_doEverything(gen, 
                            env, 
                            coords, 
                            correctGEO = TRUE, 
                            correctPC = FALSE,
                            alpha = 0.05, 
                            padj_method = "fdr")
```

## PC + Geo Correction
```{r, warning = TRUE, message = FALSE}
results <- rda_doEverything(gen, 
                            env, 
                            coords, 
                            correctGEO = TRUE, 
                            correctPC = TRUE,
                            alpha = 0.05, 
                            padj_method = "fdr")
```

## Separate functions

### 1. Prepare data
```{r}
# Standardize environmental variables
env <- scale(env, center = TRUE, scale = TRUE) 
env <- data.frame(env)
    
# Remove any NA values
if(any(is.na(env))){
  warning("NA values found in env data, removing rows with NAs for RDA")
  gen <- gen[complete.cases(env),]
  coords <- coords[complete.cases(env),]
  env <- env[complete.cases(env),]
}
if(any(is.na(gen))){
  warning("NA values found in gen data, removing rows with NAs for RDA")
  env <- env[complete.cases(gen),]
  coords <- coords[complete.cases(gen),]
  gen <- gen[complete.cases(gen),]
}
```

### 2. Run RDA
```{r}
mod <- rda_run(gen, env, coords, correctGEO = FALSE, correctPC = FALSE)
```


### 3. Identify candidate loci
```{r}
# Running with 3 axes
rda_sig <- rda_getloci(mod, gen, naxes = 3, padj_method = "fdr", alpha = 0.05)
rda_loci <- rda_sig[["rda_loci"]]
pvalues <- rda_sig[["pvalues"]]
print(rda_loci)
```

### 4. Identify environmental associations
```{r}
rda_gen <- gen[,rda_loci]
lm_df <- rda_lm_test(rda_gen, env)
```

### 5. Plot results

```{r}
rda_plot(mod, rda_loci, pvalues, biplot_axes = c(1,2), manhattan = FALSE, biplot = TRUE)
rda_plot(mod, rda_loci, pvalues, biplot_axes = c(2,3), manhattan = FALSE, biplot = TRUE)
rda_plot(mod, rda_loci, pvalues, alpha = 0.05, manhattan = TRUE, biplot = FALSE)
```
