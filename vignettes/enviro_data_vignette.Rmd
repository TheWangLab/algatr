---
title: "Environmental_data_vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Environmental_data_vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Processing environmental data

```{r setup, warning = FALSE, message = FALSE}
library(algatr)
library(terra)
library(here)
library(viridis)
```

For landscape genomic analyses, environmental data layers must be processed in several ways before they can be used as input into methods. This vignette will explore several ways to process environmental data:

-   `get_worldclim()` to pull environmental layers remotely from the WorldClim database

-   `TODO` to perform a raster PCA on a stack of environmental layers to reduce dimensionality

-   `TODO` to detect collinearity between environmental layers

-   `coords_to_raster()` to create a raster layer from coordinate data

-   `geo_dist()` to calculate geographic distances between coordinates

-   `env_dist()` to calculate environmental distances

### Gather environmental data using `get_worldclim()`

------------------------------------------------------------------------

### Raster PCA on environmental layers with \`\`

------------------------------------------------------------------------

For our test dataset, and TODO [EAC], we will be using PC-based processing of environmental layers

(1) Import environmental layers
(2) Calculate environmental distance

```{r data}
env_files <- list.files(here("inst", "extdata", "PC_layers"), full.names = TRUE)
envstack <- terra::rast(env_files)
```

Take a look at the rasters:

```{r plot rasters, fig.width = 5, fig.height = 5}
terra::plot(envstack, col = turbo(100), axes = FALSE)
```

```{r, RGB plot, fig.width = 5, fig.height = 6}
for(layer in 1:3){
  minval <- minmax(envstack[[layer]])[1,]
  maxval <- minmax(envstack[[layer]])[2,]
  
  envstack[[layer]] <- ((envstack[[layer]] - minval) / (maxval - minval))*255
}

terra::plotRGB(envstack, r = 1, g = 2, b = 3)
```

```{r}
env_files <- list.files(here("data","PC_layers"), full.names = TRUE)
envstack <- raster::stack(env_files)

# Scale rasters to get colors (each layer will correspond with R, G, or B in the final plot)
for(layer in 1:3){
    minval <- envstack[[layer]]@data@min
    maxval <- envstack[[layer]]@data@max
  
    envstack[[layer]] <- ((envstack[[layer]] - minval) / (maxval - minval))*255
  }

plotRGB(envstack, r = 1, g = 2, b = 3)

writeRaster(envstack, here("data",  "RGB_PC_stack.tif"), overwrite = TRUE)
```
